---
- name: Create a CentOS and Ubuntu docker container
  hosts: localhost

  vars:
    - container_state: reloaded
    - container_privileged: true
    - docker_containers:
        - name: ubuntu-container
          image: kevincoakley/ubuntu16.04-systemd
          ports:
            - "2200:22"
          volumes:
            - "/sys/fs/cgroup:/sys/fs/cgroup"
        - name: centos-container
          image: kevincoakley/centos7-systemd
          ports:
            - "2222:22"
          volumes:
            - "/sys/fs/cgroup:/sys/fs/cgroup"

  roles:
    - docker

  tags:
    - docker-start

- name: Test the haproxy role
  hosts: haproxy
  become: yes
  become_method: sudo

  vars:
    # Sockets and chroot aren't easy to use in Travis environments.
    haproxy_socket: ''
    haproxy_chroot: ''
    haproxy_user: root
    haproxy_group: root

    haproxy_frontends:
      - name: 'frontend'
        bind:
          - address: '*'
            port: 80
        mode: 'http'
        backend_name: 'backend'

    haproxy_backends:
      - name: 'backend'
        mode: 'http'
        balance_method: 'roundrobin'
        option:
          - 'forwardfor'
          - 'httpchk HEAD / HTTP/1.1\r\nHost:localhost'
        cookie: true
        servers:
          - name: app1
            address: 127.0.0.1:8080
            options: 'cookie app1'
          
  roles:
    - ansible-role-haproxy

  tags:
    - haproxy


- name: Remove the CentOS and Ubuntu docker containers
  hosts: localhost

  vars:
    - container_state: absent
    - docker_containers:
        - name: ubuntu-container
          image: kevincoakley/ubuntu16.04-systemd
        - name: centos-container
          image: kevincoakley/centos7-systemd

  roles:
    - docker

  tags:
    - docker-stop
